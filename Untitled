    const ENDPOINT = "https://eunoia-backend.dylan-m-jaya.workers.dev";

    const CONVO_KEY = "eunoia_conversation_id";

    function getConversationId() {
      let id = sessionStorage.getItem(CONVO_KEY);
      if (!id) {
        id = crypto.randomUUID();
        sessionStorage.setItem(CONVO_KEY, id);
      }
      return id;
    }

    function resetConversationId() {
      const id = crypto.randomUUID();
      sessionStorage.setItem(CONVO_KEY, id);
      return id;
    }

    function transcriptKey(conversationId) {
      return `eunoia_transcript_${conversationId}`;
    }

    function loadTranscript(conversationId) {
      try {
        return JSON.parse(sessionStorage.getItem(transcriptKey(conversationId)) || "[]");
      } catch {
        return [];
      }
    }

    function saveTranscript(conversationId, transcript) {
      sessionStorage.setItem(transcriptKey(conversationId), JSON.stringify(transcript));
    }

    function addToTranscript(role, content) {
      const conversationId = getConversationId();
      const transcript = loadTranscript(conversationId);
      transcript.push({ role, content, ts: Date.now() });
      saveTranscript(conversationId, transcript);
    }

    function formatTranscriptTxt(transcript) {
      return transcript
        .map((m) => {
          const time = new Date(m.ts).toLocaleString();
          const who = m.role === "user" ? "You" : "Eunoia";
          return `[${time}] ${who}:\n${m.content}\n`;
        })
        .join("\n");
    }

    function downloadFile(filename, content, mime) {
      const blob = new Blob([content], { type: mime });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();

      URL.revokeObjectURL(url);
    }

    function downloadChat() {
      const conversationId = getConversationId();
      const transcript = loadTranscript(conversationId);

      if (!transcript.length) {
        alert("No chat to download yet.");
        return;
      }

      const txt = formatTranscriptTxt(transcript);
      downloadFile(`eunoia-chat-${conversationId}.txt`, txt, "text/plain");
    }

    window.addEventListener("beforeunload", (e) => {
      const conversationId = getConversationId();
      const transcript = loadTranscript(conversationId);
      if (transcript.length > 0) {
        e.preventDefault();
        e.returnValue = ""; // triggers browser prompt
      }
    }); 

    const chatEl = document.getElementById("chat");
    const inputEl = document.getElementById("input");
    const sendBtn = document.getElementById("sendBtn");
    const downloadBtn = document.getElementById("downloadBtn");
    const composerEl = document.querySelector(".composer");

    const MAX_CHARS = Number(inputEl.getAttribute("maxlength")) || 900;
    const charCountEl = document.getElementById("charCount");

     function updateCharCount() {
      if (!charCountEl) return;
      const len = inputEl.value.length;
      charCountEl.textContent = `${len}/${MAX_CHARS}`;
    }

    function resetCharCount() {
      if (!charCountEl) return;
      charCountEl.textContent = `0/${MAX_CHARS}`;
    }

    updateCharCount();
    
    function setComposerEnabled(enabled) {
      // Only affects the input + send button; layout remains the same.
      inputEl.disabled = !enabled;
      sendBtn.disabled = !enabled;

      if (enabled) {
        composerEl.style.opacity = "1";
        composerEl.style.pointerEvents = "auto";
      } else {
        composerEl.style.opacity = "0.6";
        composerEl.style.pointerEvents = "none";
      }
      updateCharCount();
    }
    downloadBtn.addEventListener("click", downloadChat);

    // Reset conversation on page load for a fresh start
    resetConversationId();
    
    // Store conversation history for follow-up questions (starts fresh on each page load)
    let conversationHistory = [];

    function addMessage(role, text, { typing = false } = {}) {
      const wrapper = document.createElement("div");
      wrapper.className = `msg ${role}`;

      const avatar = document.createElement("div");
      avatar.className = "avatar";
      avatar.textContent = role === "user" ? "You" : "EU";

      const bubble = document.createElement("div");
      bubble.className = "bubble";

      if (typing) {
        bubble.innerHTML = `<span class="typing" aria-label="Typing">
          <span class="dot"></span><span class="dot"></span><span class="dot"></span>
        </span>`;
      } else {
        bubble.textContent = text;
      }

      wrapper.appendChild(avatar);
      wrapper.appendChild(bubble);
      chatEl.appendChild(wrapper);
      chatEl.scrollTop = chatEl.scrollHeight;
      return wrapper;
    }

    function autoResize() {
      inputEl.style.height = "auto";
      inputEl.style.height = Math.min(inputEl.scrollHeight, 160) + "px";
    }

    inputEl.addEventListener("input", () => {
      autoResize();
      updateCharCount();
    });

    inputEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    sendBtn.addEventListener("click", sendMessage);

    // Quiz data
    const quizData = [
      {
        question: "When something bothers you, how do you usually handle it?",
        options: [
          "I bring it up calmly and we talk it through",
          "I wait for the right moment, but it sometimes builds up",
          "I usually keep it to myself to avoid conflict",
          "It often turns into an argument or tension"
        ]
      },
      {
        question: "How emotionally safe do you feel expressing vulnerability with your partner?",
        options: [
          "Very safe—I can be fully myself",
          "Mostly safe, with a few reservations",
          "Somewhat guarded",
          "Not safe at all"
        ]
      },
      {
        question: "How do you and your partner typically resolve disagreements?",
        options: [
          "We listen, compromise, and move forward",
          "It takes time, but we eventually resolve them",
          "Issues often resurface without full resolution",
          "Conflicts feel repetitive or unresolved"
        ]
      },
      {
        question: "How aligned are you on long-term expectations (values, goals, future)?",
        options: [
          "Very aligned and openly discussed",
          "Mostly aligned, with some unclear areas",
          "Unsure—we haven't really talked about it",
          "Clearly misaligned or avoid the topic"
        ]
      },
      {
        question: "How often do you feel appreciated or valued by your partner?",
        options: [
          "Consistently",
          "Often, but not always",
          "Occasionally",
          "Rarely"
        ]
      },
      {
        question: "How do you feel after spending time with your partner?",
        options: [
          "Energized and emotionally fulfilled",
          "Generally positive, with occasional doubts",
          "Neutral or emotionally drained",
          "Frequently anxious or unhappy"
        ]
      },
      {
        question: "How balanced is effort in the relationship?",
        options: [
          "Very balanced",
          "Slightly uneven, but manageable",
          "Mostly one-sided",
          "Extremely one-sided"
        ]
      },
      {
        question: "How do you handle trust-related issues (jealousy, honesty, boundaries)?",
        options: [
          "Open communication and mutual trust",
          "Minor concerns, but manageable",
          "Ongoing doubts or insecurity",
          "Major trust issues"
        ]
      },
      {
        question: "When imagining your future, how does this relationship fit?",
        options: [
          "Clearly and positively",
          "Mostly positive, but uncertain",
          "Hard to imagine long-term",
          "I avoid thinking about it"
        ]
      },
      {
        question: "Overall, how would you describe your relationship right now?",
        options: [
          "Strong and healthy",
          "Stable, with room for growth",
          "Fragile or uncertain",
          "Strained or unhealthy"
        ]
      }
    ];

    const quizResults = {
      secure: {
        title: "<strong>Relationship Health:</strong> Secure & Thriving",
        scoreRange: [32, 40],
        content: `Your relationship shows strong signs of emotional safety, mutual effort, and constructive communication. Conflicts—when they arise—are generally handled in a way that strengthens trust rather than eroding it.

You and your partner appear aligned on core values and expectations, and there is a healthy balance between independence and connection. This creates a stable foundation for long-term growth.

<strong>What this means:</strong>

Your relationship risk is low. The focus is not on fixing problems, but on maintaining healthy habits and continuing intentional communication.

<strong>Suggested focus:</strong>

Reinforce what's working. Regular check-ins, appreciation, and shared future planning can help preserve this stability over time.`
      },
      stable: {
        title: "<strong>Relationship Health:</strong> Stable, with Room for Growth",
        scoreRange: [25, 31],
        content: `Your relationship is generally stable, but certain areas may benefit from more attention. Communication, alignment, or emotional needs are mostly met, though not always consistently.

There are no immediate red flags, but some patterns—such as avoided conversations or uneven effort—could become larger issues if left unaddressed.

<strong>What this means:</strong>

Your relationship risk is moderate and manageable. Small, proactive adjustments can significantly improve long-term health.

<strong>Suggested focus:</strong>

Identify one or two areas to improve—such as clearer expectations or emotional responsiveness—and address them intentionally before they become stress points.`
      },
      atRisk: {
        title: "<strong>Relationship Health:</strong> At Risk",
        scoreRange: [18, 24],
        content: `Your responses suggest recurring stress points within the relationship.

Communication may feel difficult, emotional needs may not be consistently met, or important issues may remain unresolved.

While the relationship may still have meaningful positives, there are warning signs that deserve attention. Ignoring these patterns could lead to increased dissatisfaction or emotional distance over time.

<strong>What this means:</strong>

Your relationship risk is elevated. Active intervention—through honest conversations or external support—may be necessary to restore balance.

<strong>Suggested focus:</strong>

Clarify unmet needs and address ongoing issues directly. Structured conversations or guided reflection can help determine whether improvement is possible and what changes are required.`
      },
      highRisk: {
        title: "<strong>Relationship Health:</strong> High Risk",
        scoreRange: [10, 17],
        content: `Your responses indicate significant strain within the relationship. Issues such as emotional unsafety, unresolved conflict, imbalance of effort, or trust concerns appear to be persistent.

This level of stress can take a toll on emotional well-being and may limit the relationship's ability to function in a healthy, sustainable way without substantial change.

<strong>What this means:</strong>

Your relationship risk is high. Continuing without change may lead to further emotional harm or burnout.

<strong>Suggested focus:</strong>

Prioritize emotional safety and clarity. This may involve setting firm boundaries, seeking professional support, or reassessing whether the relationship can meet your needs in its current form.`
      }
    };

    let quizAnswers = {};
    let currentQuestionIndex = 0;
    let isQuizActive = false;

    function showQuiz() {
      // Clear chat and reset quiz state
      chatEl.innerHTML = '';
      quizAnswers = {};
      currentQuestionIndex = 0;
      isQuizActive = true;

      // Hide end-of-quiz actions (if any)
      const endActionsEl = document.getElementById('endActions');
      if (endActionsEl) { endActionsEl.hidden = true; endActionsEl.innerHTML = ''; }
      
      // Hide suggestions and disable composer
      document.querySelector('.suggestions').style.display = 'none';
      document.querySelector('.composer').style.display = 'none';
      inputEl.disabled = true;
      
      // Show welcome message
      addMessage('assistant', "I'll help you discover your relationship health and risk profile. Let's start with a few questions.");
      
      // Show first question after a brief delay
      setTimeout(() => {
        showNextQuestion();
      }, 500);
    }

    function showNextQuestion() {
      if (currentQuestionIndex >= quizData.length) {
        // All questions answered, show results
        showQuizResults();
        return;
      }
      
      const question = quizData[currentQuestionIndex];
      
      // Add question as assistant message
      addMessage('assistant', question.question);
      
      // Add options as suggestion buttons
      const suggestionsDiv = document.createElement('div');
      suggestionsDiv.className = 'suggestions';
      suggestionsDiv.style.display = 'flex';
      
      question.options.forEach((option, optIndex) => {
        const optionBtn = document.createElement('button');
        optionBtn.className = 'suggestion-btn';
        optionBtn.textContent = option;
        optionBtn.dataset.questionIndex = currentQuestionIndex;
        optionBtn.dataset.optionIndex = optIndex;
        
        optionBtn.addEventListener('click', () => {
          // Store answer (A=4, B=3, C=2, D=1, but we use 0-3 index, so: 0=4, 1=3, 2=2, 3=1)
          quizAnswers[currentQuestionIndex] = 4 - optIndex;
          
          // Add user's answer as a message
          addMessage('user', option);
          
          // Remove options
          suggestionsDiv.remove();
          
          // Move to next question
          currentQuestionIndex++;
          setTimeout(() => {
            showNextQuestion();
          }, 500);
        });
        
        suggestionsDiv.appendChild(optionBtn);
      });
      
      chatEl.appendChild(suggestionsDiv);
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    function showQuizResults() {
      isQuizActive = false;
      
      // Calculate score
      const totalScore = Object.values(quizAnswers).reduce((sum, score) => sum + score, 0);
      
      // Determine result category
      let result;
      if (totalScore >= 32) {
        result = quizResults.secure;
      } else if (totalScore >= 25) {
        result = quizResults.stable;
      } else if (totalScore >= 18) {
        result = quizResults.atRisk;
      } else {
        result = quizResults.highRisk;
      }
      
      // Add result as assistant message with HTML formatting
      const resultText = `${result.title}\n\n${result.content}`;
      const resultHTML = resultText.replace(/\n/g, '<br>');
      
      // Create message with HTML support
      const wrapper = document.createElement("div");
      wrapper.className = "msg assistant";

      const avatar = document.createElement("div");
      avatar.className = "avatar";
      avatar.textContent = "EU";

      const bubble = document.createElement("div");
      bubble.className = "bubble";
      bubble.innerHTML = resultHTML;

      wrapper.appendChild(avatar);
      wrapper.appendChild(bubble);
      chatEl.appendChild(wrapper);
      
      // Add refresh button
      const refreshDiv = document.createElement('div');
      refreshDiv.className = 'suggestions';
      refreshDiv.style.display = 'flex';
      
      const refreshBtn = document.createElement('button');
      refreshBtn.className = 'suggestion-btn';
      refreshBtn.textContent = 'Start a new conversation';
      refreshBtn.addEventListener('click', () => {
        // Triggers the same unsaved-updates warning via beforeunload.
        window.location.reload();
      });
      refreshDiv.appendChild(refreshBtn);
      chatEl.appendChild(refreshDiv);
      
      chatEl.scrollTop = chatEl.scrollHeight;
      
      // Quiz finished: keep the composer disabled until a new conversation starts.
      composerEl.style.display = 'flex';
      inputEl.value = '';
      setComposerEnabled(false);
      autoResize();
      resetCharCount();
      document.querySelector('.composer').style.display = 'none';
      
      // Add to transcript (plain text version)
      addToTranscript('assistant', resultText.replace(/<[^>]*>/g, ''));
      
      // Add quiz results to conversation history for AI context
      const quizResultForHistory = `Based on your relationship health assessment, here's my analysis:\n\n${resultText.replace(/<[^>]*>/g, '')}`;
      conversationHistory.push({ 
        role: "assistant", 
        content: quizResultForHistory
      });
    }

    // Handle suggested question buttons
    document.querySelectorAll('.suggestion-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const question = btn.getAttribute('data-question');
        
        // Special handling for quiz button
        if (question === "Discover your relationship health and risk profile.") {
          showQuiz();
        } else {
          inputEl.value = question;
          autoResize();
          sendMessage();
        }
      });
    });

    function extractReply(data) {
      return (
        data?.outputs?.["out-0"] ??
        data?.outputs?.out0 ?? 
        JSON.stringify(data, null, 2)
      );
    }


    async function sendMessage() {
      if (sendBtn.disabled || isQuizActive) return;

      const message = inputEl.value.trim();
      if (!message) return;

      // Hide suggestions after first message
      const suggestionsEl = document.querySelector('.suggestions');
      if (suggestionsEl && !isQuizActive) {
        suggestionsEl.style.display = 'none';
      }

      addMessage("user", message);
      addToTranscript("user", message);
      
      // Add user message to conversation history
      conversationHistory.push({ role: "user", content: message });
      const trimmedHistory = conversationHistory.slice(-10);
      const MAX_CHARS_PER_MESSAGE = 900;
      const cappedHistory = trimmedHistory.map(m => {
        if (m.content.length > MAX_CHARS_PER_MESSAGE) {
          return {
            role: m.role,
            content: String(m.content || "").slice(0, MAX_CHARS_PER_MESSAGE)
          };
        }
        return m;
      });
      
      inputEl.value = "";
      autoResize();
      resetCharCount();

      sendBtn.disabled = true;
      downloadBtn.disabled = true;
      const typingRow = addMessage("assistant", "", { typing: true });

      try {
        const conversationId = getConversationId();
        const response = await fetch(ENDPOINT, {
          method: "POST",
          mode: "cors",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ 
            message, 
            conversationId,
            history: cappedHistory 
          })
        });

        const data = await response.json();

        if (!response.ok) {
          typingRow.querySelector(".bubble").textContent =
            data?.error ? `Error: ${data.error}` : `Error: HTTP ${response.status}`;
          return;
        }

        const reply = extractReply(data);
        typingRow.querySelector(".bubble").textContent = reply;
        addToTranscript("assistant", reply);
        
        // Add assistant response to conversation history
        conversationHistory.push({ role: "assistant", content: reply });
      } catch (err) {
        typingRow.querySelector(".bubble").textContent =
          "Sorry, I'm having trouble right now. Please try again later. Thank you for your patience!";
        console.error(err);
      } finally {
        sendBtn.disabled = false;
        downloadBtn.disabled = false;
        chatEl.scrollTop = chatEl.scrollHeight;
      }
    }

    addMessage("assistant", "Hi! I’m Eunoia. Tell me what’s going on, and I’ll help you think it through.");